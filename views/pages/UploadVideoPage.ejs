<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Upload</title>

    <!-- Font Awesome kit script -->
    <script src="https://kit.fontawesome.com/a81368914c.js"></script>
    <!-- Google Fonts Open Sans-->
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">
    <!-- jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>


    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>

</head>

<style>
    .file-upload input[type='file'] {
        display: none;
    }

    body {
        background: #00B4DB;
        background: -webkit-linear-gradient(to right, #0083B0, #00B4DB);
        background: linear-gradient(to right, #0083B0, #00B4DB);
        height: 100vh;
    }

    .rounded-lg {
        border-radius: 1rem;
    }

    .custom-file-label.rounded-pill {
        border-radius: 50rem;
    }

    .custom-file-label.rounded-pill::after {
        border-radius: 0 50rem 50rem 0;
    }

    #loading-btn {
        display: none;
        margin-top: 10px;
    }

    .progress-loading {
        display: none;
    }
</style>

<body>
    <div class="container p-5">
        <div class="row mb-5 text-center text-white">
            <div class="col-lg-10 mx-auto">
                <h1 class="display-4">Welcome <%= user.name %>
                </h1>
                <p class="lead">
                    <%= user.email %>
                </p>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-5 mx-auto">
                <div class="p-5 bg-white shadow rounded-lg"><img
                        src="https://pp.netclipart.com/pp/s/251-2515071_upload-button-clipart-circle-upload-button.png" alt="" width="200"
                        class="d-block mx-auto mb-4 rounded-pill">

                    <!-- Default bootstrap file upload-->

                    <h6 class="text-center mb-4 text-muted">
                        Choose the file to upload.
                    </h6>

                    <div class="custom-file overflow-hidden rounded-pill mb-5">
                        <input id="customFile" type="file" class="custom-file-input rounded-pill">
                        <label for="customFile" class="custom-file-label rounded-pill">Choose file</label>
                    </div>
                    <!-- End -->

                    <h6 class="text-center mb-4 text-muted" id="fileName"></h6>

                    <!-- progress bar  -->
                    <div class="progress-loading">
                        <div class="progress progress-striped active">
                            <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0"
                                aria-valuemax="100">
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-center">
                        <button class="btn btn-success" id="upload-btn">Upload</button>

                        <button class="btn btn-primary" type="button" id="loading-btn" disabled>
                            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                            Uploading...
                        </button>
                    </div>
                    <!-- End -->
                </div>
            </div>
        </div>
    </div>

    <script>
        $('#customFile').change(function (e) {
            var fileName = e.target.files[0].name;
            $('#fileName').text(fileName);
        });

        $('button').on('click', () => {

            let userId = `<%= user.id %>`
            let video = $("#customFile")[0].files[0];
            if (!video) {
                alert('Please select a video first')
                return
            }

            $('.progress-loading').css('display', 'block');
            $('#loading-btn').css('display', 'block');
            $('#upload-btn').hide();

            let formData = new FormData();
            formData.append('video', video);
            formData.append('userId', userId)
            $.ajax({
                type: 'post',
                processData: false,
                contentType: false,
                url: `/api/video/upload`,
                data: formData,
                enctype: 'multipart/form-data',
                xhr: function () {
                    var xhr = new window.XMLHttpRequest();
                    xhr.upload.addEventListener("progress", function (evt) {
                        if (evt.lengthComputable) {
                            var percentComplete = evt.loaded / evt.total;
                            percentComplete = parseInt(percentComplete * 100);
                            $('.progress-bar').css('width', percentComplete + '%').attr('aria-valuenow', percentComplete);
                        }
                    }, false);
                    return xhr;
                },
                success: data => {
                    alert('Video Uploaded Successfully');

                    $("#customFile").val(null);
                    $('#fileName').text('');

                    $('#loading-btn').hide();
                    $('.progress-loading').hide();
                    $('#upload-btn').show();
                    // window.location.replace('https://timeslot.citystvnetwork.com/dashboard');
                },
                error: (e) => {
                    console.log(e);

                    $('#loading-btn').hide();
                    $('.progress-loading').hide();
                    $('#upload-btn').show();
                    alert('Something went wrong while upload video');
                },
            })
        });

    </script>

</body>

</html>